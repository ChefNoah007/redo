#!/usr/bin/env node

/**
 * This script creates a metafield to store the API URL for client-side JavaScript files.
 * 
 * Usage:
 * node scripts/setup-api-url-metafield.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { parse } from '@iarna/toml';
import dotenv from 'dotenv';

// Get the directory name using ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

// Load environment variables
dotenv.config({ path: path.join(rootDir, '.env') });

async function setupApiUrlMetafield() {
  try {
    console.log('Setting up API URL metafield...');
    
    // Get the API URL from environment variables or TOML file
    let apiUrl = process.env.SHOPIFY_APP_URL;
    
    // If not found in environment variables, try to get it from the TOML file
    if (!apiUrl) {
      const tomlPath = path.join(rootDir, 'shopify.app.toml');
      if (fs.existsSync(tomlPath)) {
        const tomlContent = fs.readFileSync(tomlPath, 'utf8');
        const tomlData = parse(tomlContent);
        apiUrl = tomlData.application_url || '';
      }
    }
    
    if (!apiUrl) {
      console.error('Error: Could not find SHOPIFY_APP_URL in environment variables or application_url in shopify.app.toml');
      process.exit(1);
    }
    
    // Create a JavaScript file that sets the API URL as a global variable
    const jsContent = `
// This file is auto-generated by setup-api-url-metafield.js
// It sets the API URL for client-side JavaScript files

window.API_URL = "${apiUrl}";
`;
    
    const outputPath = path.join(rootDir, 'extensions/ai-agent/assets/api-url.js');
    fs.writeFileSync(outputPath, jsContent);
    
    console.log(`âœ… API URL JavaScript file created successfully at ${outputPath}`);
    console.log(`API URL: ${apiUrl}`);
    
  } catch (error) {
    console.error('Error setting up API URL metafield:', error);
    process.exit(1);
  }
}

setupApiUrlMetafield();
